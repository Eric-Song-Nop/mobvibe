# 新建对话工作目录弹窗优化

## 实现前计划

### 目标

- 新建对话弹窗初始仅展示标题、后端与工作目录输入框。
- 点击工作目录的“浏览”按钮后打开独立文件浏览器弹窗。
- 目录选择后回填但不自动关闭，同时保留手动输入能力。
- 文件浏览器弹窗空间更大，便于后续复用与扩展。

### 交互方案

- 工作目录输入框保持可编辑，右侧提供“浏览”按钮打开弹窗。
- 弹窗默认定位到当前已选路径（无则回到 Home）。
- 点击目录或列标题更新路径，弹窗保持打开。
- 输入路径并回车时更新目录列，手动关闭弹窗。

### 架构调整

- 新增独立的 `WorkingDirectoryDialog` 组件，内部复用 `WorkingDirectoryPicker`。
- `WorkingDirectoryPicker` 增加选择回调与高度配置，支持弹窗模式。
- `CreateSessionDialog` 改为输入框 + 浏览按钮，并管理目录弹窗开关。

### 影响范围

- 前端 UI：`CreateSessionDialog`、`WorkingDirectoryPicker`。
- 新增组件：`WorkingDirectoryDialog`。
- 文档：新增实现记录与使用说明。

## 实现后记录

### 前端实现

- 新建对话使用可编辑输入框与“浏览”按钮打开独立目录弹窗。
- 弹窗默认定位到当前路径，未选路径时自动填充 Home。
- 新增 `WorkingDirectoryDialog` 作为独立弹窗容器，提供更大浏览空间。
- `WorkingDirectoryPicker` 支持选择回调、可配置浏览高度与输入框 ID。
- 弹窗内选择目录只刷新路径，不会自动关闭。

### 使用说明

- 在新建对话弹窗中，可直接输入路径或点击“浏览”。
- 弹窗内点击目录或列标题会刷新路径，手动关闭弹窗返回。
- 手动输入路径后回车会刷新目录，不会自动关闭。

## 本次调整（实现前计划 - 2026-01-19 默认工作目录记忆）

### 目标

- 新建对话时默认使用上一次创建成功的工作目录。
- 若无历史记录则回退到 Home 目录。
- 默认目录记录跨刷新持久化到 localStorage。

### 实现方案

- `chat-store` 新增 `lastCreatedCwd` 并加入持久化字段。
- 创建会话成功后更新 `lastCreatedCwd`，失败/取消不更新。
- 打开创建弹窗时优先使用 `lastCreatedCwd` 作为默认值。
- 若 `lastCreatedCwd` 为空，则继续使用 `/fs/roots` 返回的 `homePath`。

### 影响范围

- 前端状态存储：`apps/web/src/lib/chat-store.ts`。
- 创建弹窗逻辑：`apps/web/src/App.tsx`、`apps/web/src/components/app/CreateSessionDialog.tsx`。
- 文档补充实现后记录与使用说明。

## 本次调整（实现后记录 - 2026-01-19 默认工作目录记忆）

### 实现结果

- 新建对话默认使用上一次成功创建会话的工作目录。
- 若无历史记录则回退到 Home 目录。
- 记忆的工作目录写入 `localStorage`，刷新后仍生效。

### 使用说明

- 新建对话弹窗会自动填入最近一次成功创建的工作目录。
- 若未创建过会话，则默认填入 Home 目录。
- 创建失败或取消不会覆盖默认目录。

## 本次调整（实现前计划 - 2026-01-20 新建对话弹窗宽度）

### 目标

- 新建对话弹窗在桌面端更宽，避免表单区域拥挤。
- 移动端保持全屏展示，避免布局变窄。

### 实现方案

- 调整 `CreateSessionDialog` 的弹窗容器宽度，覆盖默认 `max-w`。
- 维持表单分组与布局结构不变。

### 结构与影响范围

- 前端 UI：`apps/web/src/components/app/CreateSessionDialog.tsx`。
- 文档：补充实现后记录与使用说明。

### 架构说明

- 仅调整弹窗容器尺寸样式，不改动状态管理与创建流程。

## 本次调整（实现后记录 - 2026-01-20 新建对话弹窗宽度）

### 实现结果

- `CreateSessionDialog` 桌面端宽度提升为接近全屏的矩形布局。
- 移动端保持全屏展示，不影响当前交互。

### 架构说明

- 调整仅发生在弹窗容器样式层，表单逻辑保持不变。

### 使用说明

- 新建对话弹窗在桌面端会自动加宽，表单区域更宽敞。

## 本次调整（实现前计划 - 2026-01-27 新建会话目录选择报错修复）

### 目标

- 修复新建会话选择工作目录时报错 `replace` 为空导致的目录浏览失败。
- 保持目录选择仅显示文件夹的既有交互，不改动 UI 结构。

### 问题定位

- `/fs/entries` 返回缺少 `path` 字段，导致前端 `useColumnFileBrowser` 对 `undefined` 调用 `replace`。
- 返回的 `entries` 字段结构与 `FsEntry` 类型不一致（缺 `type/hidden`），导致前端过滤逻辑不可靠。

### 实现方案

- 后端 `/fs/entries` 返回 `{ path, entries }`，补齐 `path`。
- 统一 `entries` 为 `FsEntry` 结构：`{ name, path, type, hidden }`。
- 保持前端 `WorkingDirectoryPicker` 使用 `filterEntry` 仅展示目录，不新增 UI 逻辑。

### 验证方式

- 打开新建会话弹窗，点击“浏览”进入目录列表不再报错。
- 目录列表可进入子目录，当前路径可正常更新。

## 本次调整（实现后记录 - 2026-01-27 新建会话目录选择报错修复）

### 实现结果

- `/fs/entries` 返回结构补齐 `path` 字段。
- `entries` 统一为 `FsEntry` 结构（`type/hidden`），前端目录过滤不再异常。

### 使用说明

- 新建会话弹窗中点击“浏览”可正常加载目录列表。
- 仍然只展示目录项，文件条目不会出现在目录选择器中。
