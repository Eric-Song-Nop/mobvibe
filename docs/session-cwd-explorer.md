# 会话工作目录选择器（Finder 风格）

## 实现前计划

### 目标

- 创建会话时允许用户选择工作目录（cwd），仅允许目录。
- 文件浏览器采用 Finder 风格横向列布局，移动端可横向滑动。
- 仅允许从 Home 目录开始浏览，输入路径与浏览路径都必须限制在 Home 内。
- 支持手动输入/粘贴路径，隐藏项可见。

### 后端方案

- 新增文件浏览接口：
  - `GET /fs/roots`：返回 Home 根信息。
  - `GET /fs/entries?path=...`：返回指定目录下的条目列表。
- 统一路径校验：
  - 以 `os.homedir()` 为根，拒绝所有解析后不在 Home 内的路径。
  - 使用 `realpath` 解析符号链接，避免绕过根目录限制。
- 返回结构包含 `name`、`path`、`type`（目录/文件）、`hidden` 等基础信息。

### 前端方案

- 创建会话弹窗加入工作目录选择器：
  - 顶部提供路径输入框（可手动输入/粘贴）。
  - 中部为横向滚动列视图，每列展示当前路径下的目录与文件。
  - 仅目录可点击选中，文件仅展示。
- 选中路径回填到创建会话请求 `cwd`。

### 交互与布局

- 移动端优先：列宽固定、横向滑动、点击目录进入下一列。
- 列表展示隐藏项（以 `.` 开头的目录/文件）。
- 选中目录高亮，顶部显示当前选中路径。

### 测试计划

- 后端：覆盖 `/fs/roots`、`/fs/entries` 路径校验、越界、非目录与不存在情况。
- 前端：覆盖 `WorkingDirectoryPicker` 目录过滤、列更新与居中滚动。
- 流程：覆盖新建对话未选目录禁用与选中目录后可创建。

### 影响范围

- 后端：新增文件浏览 API、路径校验工具函数。
- 前端：新增 API 调用、文件选择器组件、创建会话弹窗扩展。
- 文档：补充实现后记录与使用说明。

## 实现后记录

### 后端实现

- 新增 `/fs/roots` 与 `/fs/entries` 接口，提供 Home 根路径与目录条目信息。
- 后端统一路径校验：仅允许 Home 内目录，解析符号链接后越界直接拒绝。
- `POST /acp/session` 在创建会话时校验 `cwd`，并使用解析后的真实路径。

### 前端实现

- 创建会话弹窗新增 Finder 风格文件选择器，横向列展示目录结构。
- 支持手动输入/粘贴路径并跳转，输入框同步显示当前选中目录。
- 仅目录可点击进入/选择，文件只展示不可选。
- 选择器默认定位到 Home 根目录，移动端支持横向滑动。
- 列视图区使用独立横向滚动容器，确保多列可左右滑动。
- 当前选中列自动保持在可视区域中部。
- 仅展示可进入的目录，不再显示文件条目。
- 每列目录列表固定高度并支持纵向滚动。

### 测试补充

- 后端新增 `fs-routes` 测试覆盖根目录、越界、非目录与缺失路径。
- 前端新增 `WorkingDirectoryPicker` 测试覆盖目录过滤、列更新与居中滚动。
- 新建会话流程测试覆盖未选目录禁用与选中目录后创建。

### 使用说明

- 打开“新建对话”弹窗，输入或选择工作目录后再创建会话。
- 若路径不在 Home 内或无权限，会提示错误并阻止创建。

## 测试修复（2026-01-16）

### 实现前计划

- 统一前端测试的模块导入方式，避免 React 重复实例。
- 精简 `vite.config.ts` 的 React 相关别名与 `preserveSymlinks` 设置。
- 清理 `setup-tests.ts` 重复导入，补齐测试所需依赖。
- 运行 `pnpm test --filter web` 复核测试结果。

### 架构与影响

- Vitest 测试依赖 `apps/web/src` 与 `vite.config.ts` 的模块解析结果。
- React 依赖需要在测试进程中保持单实例，避免 hook 运行时错误。
- `setup-tests.ts` 负责统一测试运行环境的全局补丁。

## 测试回滚（2026-01-16）

### 实现前计划

- 恢复 `apps/web/vite.config.ts` 的 React 相关 alias 与 `preserveSymlinks` 设置。
- 还原 `apps/web/src/setup-tests.ts` 的原始导入结构。
- 删除工作目录相关的两份前端测试用例内容。
- 如需验证，再单独运行 `pnpm test --filter web`。

### 架构与影响

- 仅影响前端测试与 Vite 测试解析配置，不改动业务逻辑。
- 移除测试用例后，工作目录选择器与创建流程将不再被自动化覆盖。

### 实现后记录

- 恢复 `apps/web/vite.config.ts` 的 React alias 与 `preserveSymlinks` 配置为原始状态。
- `apps/web/src/setup-tests.ts` 回滚为原始双重导入结构。
- 删除 `apps/web/tests/working-directory-picker.test.tsx` 与 `apps/web/tests/create-session-flow.test.tsx` 测试文件。
- 未重新运行前端测试。
