# 会话内文件浏览器与预览（移动端优先）

## 2026-01-20 预览定位优化计划

### 目标

- 点击 `@filename` 预览时自动定位到文件所在列。
- 预览打开后依然可返回根目录继续浏览，避免锁定父目录。
- 不改变现有移动端/桌面端的浏览与预览布局。

### 前端方案

- `FileExplorerDialog` 在 `initialFilePath` 变化时仅构建列，不覆写路径状态。
- 记录上次预览路径，避免重复触发列构建造成视图跳动。
- 保持根目录列存在，允许用户从最左列返回导航。

### 测试计划

- 前端补充用例：预览路径进入时调用列构建，并以父目录作为定位目标。

### 架构与影响

- `FileExplorerDialog` 仅触发列构建，避免覆写浏览路径状态。
- 列式浏览逻辑继续由 `useColumnFileBrowser` 负责路径分段与滚动定位。

## 2026-01-20 预览定位优化记录

### 前端实现

- 预览路径变化时构建文件父目录列，保留根目录列以便返回导航。
- 记录上次预览路径，避免重复构建导致的滚动跳动。

## 2026-01-20 代码预览全屏与大纲体验优化计划

### 目标

- 代码预览支持全屏模式，移动端只展示源代码并保留切换按钮。
- 大纲无符号时隐藏入口与面板，避免空白占位。
- 移动端点击大纲项时可回到代码视图并定位行。
- 移动端长按大纲项复制对应符号源码。

### 前端方案

- `CodePreview` 增加全屏状态与 Esc 退出逻辑。
- 全屏时隐藏语言与行数信息，仅保留代码/大纲/全屏切换按钮。
- 大纲准备完成但无符号时隐藏按钮与面板。
- 修复移动端长按事件：区分 touch 与 pointer，避免点击与复制冲突。

### 架构与影响范围

- 代码预览组件：`apps/web/src/components/app/previews/CodePreview.tsx`。
- 样式：`apps/web/src/components/app/previews/preview.css`。
- 文案：`apps/web/src/i18n/locales/zh/translation.json`。
- 交互状态：新增全屏状态与移动端事件处理，保持原有解析流程不变。

## 2026-01-20 代码预览全屏与大纲体验优化记录

### 前端实现

- `CodePreview` 增加全屏模式，进入后仅展示代码区域与控制按钮，支持 Esc 退出。
- 大纲无符号时隐藏入口与面板，避免展示空白视图。
- 移动端点击大纲项会切回代码面板并定位到对应行。
- 大纲长按复制在移动端通过 touch 事件触发，避免与点击跳转冲突。

### 架构说明

- 仅调整预览视图与交互状态，Tree-sitter 解析逻辑保持不变。

### 使用说明

- 点击代码预览右上角全屏按钮进入/退出全屏。
- 有大纲符号时才会显示大纲入口。
- 移动端点击大纲项跳转到代码位置，长按可复制符号源码。

## 2026-01-17 会话文件弹窗宽度加强计划

### 目标

- 解决桌面端弹窗仍被默认 `max-w` 约束的问题。
- 让会话文件弹窗在桌面端明显变宽，预览区域可见。

### 前端方案

- 使用 `!max-w`/`!w` 覆盖 `AlertDialogContent` 的默认宽度限制。
- 将桌面端宽度提升到接近全屏的横向矩形（`98vw`）。

## 2026-01-17 会话文件弹窗尺寸修复计划

### 目标

- 修复文件管理器与预览溢出容器的问题。
- 桌面端会话文件弹窗使用更宽的矩形布局。
- 保证列式浏览与预览在容器内滚动、不撑破父层。

### 前端方案

- 调整会话文件弹窗容器尺寸与溢出控制（`overflow-hidden`、`min-h-0`）。
- 列式浏览组件补充高度与滚动约束，避免内容撑破。
- 预览区与浏览区在桌面端使用更宽的 `vw` 宽度。

## 2026-01-17 列式浏览改造计划

### 目标

- 会话文件浏览与工作目录选择共享同一套列式浏览体验（Finder 风格）。
- 列表中目录与文件同列展示，点击文件更新预览（桌面）/切换预览（移动端）。
- 复用列式浏览的核心逻辑与 UI，减少重复实现。
- 弹窗尺寸更大，移动端可全屏显示文件管理与预览区域。

### 前端方案

- 抽离列式浏览 Hook + 组件：负责路径分段、列数据、滚动定位与选择交互。
- 工作目录选择器复用列式浏览组件，仅显示目录条目，保留路径输入。
- 会话文件浏览改用列式浏览组件，展示文件与目录并触发预览加载。
- 调整两个弹窗的布局尺寸：移动端全屏、桌面端更大宽高。

### 架构与影响范围

- 新增共享的列式浏览组件/Hook。
- 调整 `WorkingDirectoryPicker` 与 `FileExplorerDialog` 的结构与交互。
- 更新相关样式与移动端布局逻辑。

## 实现前计划

### 目标

- 在会话顶部状态栏提供文件浏览入口，仅在存在激活会话时可用。
- 文件浏览范围严格限制在会话 `cwd` 内，不允许越界访问。
- 移动端优先的浏览体验：目录列表与预览可切换，桌面端支持左右分栏。
- 点击文件即可预览，支持代码高亮与图片展示。
- 保持可扩展的预览渲染器机制，未来可追加图片、PDF 等类型。

### 后端方案

- 在 session 记录中保存 `cwd`（创建会话时写入），用于文件访问范围判断。
- 新增会话限定文件接口：
  - `GET /fs/session/roots?sessionId=...`：返回会话根目录（cwd）。
  - `GET /fs/session/entries?sessionId=...&path=...`：列出目录条目。
  - `GET /fs/session/file?sessionId=...&path=...`：读取文件内容并返回预览数据。
- 路径校验：
  - 以会话 `cwd` 为根，`realpath` 后仍需在根目录内。
  - 文件访问与目录访问分开校验，禁止访问不存在或越界路径。
- 预览响应结构示例：
  - `{ path, previewType: "code" | "image", content, mimeType?: string }`
  - 预留 `previewType` 扩展空间。

### 前端方案

- 新增 API 客户端方法与类型：会话文件 root/entries/file。
- 新增文件浏览弹窗组件：
  - 左侧为目录/文件列表，移动端支持列表与预览切换。
  - 右侧为预览（桌面端分栏）。
- 预览组件采用“渲染器注册表”模式：
  - 以 `previewType` 作为 key 映射到具体预览组件。
  - `code` 渲染器使用 `prism-react-renderer`（gruvbox light/dark），支持软换行与行号。
  - 实现 `image` 渲染器，并预留 `pdf` 等扩展。
- 顶部状态栏新增图标按钮，仅在激活会话存在时展示/启用。


### 交互与布局

- 移动端：浏览器全屏弹窗，列表与预览通过顶部按钮切换。
- 桌面端：左右分栏，列表固定宽度、预览区域自适应。
- 文件条目点击后即加载预览，目录点击进入下一层级。
- 列表与预览均支持纵向滚动。

### 影响范围

- 后端：SessionManager 保存 cwd，新增会话限定文件访问 API。
- 前端：新增 API、浏览弹窗、预览渲染器、状态栏入口。
- 文档：补充实现后记录与使用说明。

## 实现后记录

### 后端实现

- SessionManager 记录会话 `cwd`，并透出到会话摘要响应中。
- 新增 `/fs/session/roots`、`/fs/session/entries`、`/fs/session/file` 接口。
- 文件/目录访问统一限制在会话 `cwd` 内，越界与非法路径直接返回错误。
- 预览接口支持 `previewType: "code" | "image"`，图片以 base64 data URL 形式返回。

### 前端实现

- 状态栏新增文件夹图标按钮，仅在激活会话存在且有 `cwd` 时显示。
- 新增 `FileExplorerDialog` 弹窗：移动端提供“目录/预览”切换，桌面端左右分栏。
- 目录列表同时展示文件与目录，目录点击进入、文件点击加载预览。
- 预览采用渲染器注册表模式，`code` 渲染器使用 gruvboxMaterialLight/ gruvboxMaterialDark 主题并支持软换行行号。
- 点击 `@filename` 预览时，列式浏览自动定位到文件所在列且保持根目录可返回。

### 使用说明

- 创建会话并选择工作目录后，点击顶部文件夹图标打开浏览器。
- 点击目录进入下一层级，点击文件即可查看代码或图片预览。
- 在消息中点击 `@filename` 可直接定位到目标文件并预览。

## 2026-01-17 列式浏览改造记录

### 前端实现

- 抽离 `ColumnFileBrowser` 与 `useColumnFileBrowser`，统一列式滚动、路径分段与列数据构建。
- `WorkingDirectoryPicker` 复用共享列式浏览，仅展示目录条目。
- `FileExplorerDialog` 使用列式浏览展示目录与文件，点击文件更新预览并在移动端切换到预览。
- 两个弹窗调整为移动端全屏、桌面端更大尺寸，浏览区域可自适应撑满。

### 使用说明

- 工作目录选择与会话文件浏览均为横向列式滚动浏览。
- 移动端使用“目录/预览”切换，桌面端左右分栏实时预览。

## 2026-01-17 会话文件弹窗尺寸修复记录

### 前端实现

- 会话文件弹窗改为桌面端 `90vw` 宽度并设置 `overflow-hidden`，避免内容溢出。
- 列式浏览容器补充 `min-h-0`/`min-w-0` 与 flex 约束，让内部滚动而非撑破外层。
- 预览区与浏览区增加 `overflow-hidden`，确保内容始终落在弹窗内。
- 桌面端弹窗宽度调整为 `95vw`，确保预览区域可见。

## 2026-01-17 会话文件弹窗宽度加强记录

### 前端实现

- 使用 `!max-w`/`!w` 覆盖默认宽度限制，桌面端提升到 `98vw`。
